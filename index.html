<!DOCTYPE html>
<html>

<head>
  <title>Subsonic Webui</title>
  <!-- MD5 implementation, because js doesn't have a builtin for it -->
  <!-- Alternative would be to rely on plain password, the OSS POST extension or the OSS API key extension. -->
  <script src="https://pajhome.org.uk/crypt/md5/md5.js"></script>
  <script>
    let subsonic_handler;

    class SubsonicHandler {
      /**
      * @param {string} server
      * @param {string} username
      * @param {string} password
      */
      constructor(server, username, password) {
        this.username = username;
        this.server = server;
        this.password = password;
      }

      /**
      * @param {string} view
      * @param {URLSearchParams} params
      */
      build_request(view, params) {
        // see https://opensubsonic.netlify.app/docs/api-reference/
        params.append("u", this.username);
        params.append("v", "1.16.0");
        params.append("c", "subsonic-webui");
        params.append("f", "json");

        // ideally would use the crypto lib for both md5 and salt gen.
        // Why didn't I just do that? Spite and sunk cost. Mostly spite.
        let salt = "";
        for (let i = 0; i < 4; i++) {
          let rand = Math.floor(Math.random() * 255).toString(16).padStart(2, '0');
          salt = salt + rand;
        }

        let token = hex_md5(`${this.password}${salt}`);
        params.append("t", token);
        params.append("s", salt);

        return `${this.server}/rest/${view}?${params}`;
      }

      /**
      * @param {string} view
      * @param {URLSearchParams} params
      */
      async json_request(view, params) {
        return await (await fetch(this.build_request(view, params))).json();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const dialog = document.querySelector("dialog");
      const err_msg = document.querySelector("form #error");
      dialog.showModal();

      document.querySelector("form#auth").addEventListener("submit", async (ev) => {
        let creds = new FormData(ev.target);
        subsonic_handler = new SubsonicHandler(creds.get("server"), creds.get("name"), creds.get("password"));
        try {
          let resp = (await subsonic_handler.json_request("ping", new URLSearchParams()))["subsonic-response"];
          if (resp.status != "ok") {
            throw new Error(resp.error.message);
          }
          err_msg.innerText = "";
        } catch (err) {
          document.querySelector("form #error").innerText = err.toString();
          document.querySelector("dialog").showModal();
        }
      })
    });
  </script>
</head>

<body>
  <!-- Dialog shown on load. Credentials API isn't standard yet across browsers, what can you do -->
  <dialog>
    <form id="auth" method="dialog">
      <h1>Subsonic Login</h1>
      <label for="auth-server">Server: </label>
      <input id="auth-server" name="server" type="url" placeholder="https://demo.navidrome.org" required />

      <label for="auth-name">Username: </label>
      <input id="auth-name" name="name" type="text" placeholder="demo" required />

      <label for="auth-pass">Password: </label>
      <input id="auth-pass" name="password" type="password" placeholder="demo" required />

      <button type="submit">Login</button>

      <p id="error"></p>
    </form>
  </dialog>

  <!-- Main holds directory nav. Button to return to root for convenience. Will follow the same conventions as github/forgejo having .. to go up one dir. -->
  <main>
    <button type="submit">Root</button>
    <ul id="curr-dir">
    </ul>
  </main>

  <!-- Aside holds metadata about the playing song. Side drawer on landscape, bottom drawer on portrait -->
  <aside>
    <h2 id="aside-title"></h2>
    <h4 id="aside-album"></h4>
    <img src="about:blank" id="aside-cover" />
    <audio controls src="about:blank" id="aside-audio"></audio>
  </aside>
</body>

</html>